<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Philippine School Road Safety</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    
    html {
  scroll-behavior: smooth;
}

    body {
      margin: 0 50px;
      padding: 50px;
      font-family: sans-serif;
      line-height: 1.15;
    }
    .city-buttons button.active {
  background-color: #d32f2f;
  color: white;
  border: 1px solid #b71c1c; /* optional: darker red border */
  height: 10px;
}

    .map-chart-container {
      display: flex;
      gap: 2rem;
      margin: 2rem 0;
    }
    #map {
      flex: 2;
      height: 1200;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
      position: relative;
      width: 65%;
    }
    #chart-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #controls {
      background: white;
      padding: 10px;
      border-radius: 8px;
      font-family: sans-serif;
      position: absolute;
      z-index: 1200;
      bottom: 30px;
      left: 10px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    #yearSlider {
  width: 100px;
}

    .city-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .city-buttons button {
      padding: 6px 12px;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
    }
    .city-buttons button:hover {
      background-color: #ddd;
    }
    .legend {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      font-size: 0.9rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .legend-color {
      display: inline-block;
      width: auto;
      height: auto;
      font-size: 18px;
      color: inherit;
    }
    /* Sidebar layout */
body {
  margin: 0;
  display: flex;
  font-family: sans-serif;
}

.sidebar {
  width: 220px;
  height: 100vh;
  background: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.9)), url('project1_cropped.png') center center / cover no-repeat;
  color: white;
  position: fixed;
  top: 0;
  left: 0;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 1.5rem 1rem;
}

.sidebar h2 {
  margin: 0 0 2rem;
  font-size: 1.3rem;
  text-align: center;
}

.side-nav {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.side-nav a {
  color: white;
  text-decoration: none;
  font-weight: bold;
  padding: 0.5rem 0.75rem;
  border-radius: 4px;
  transition: background-color 0.3s ease;
}
    
/* Main content shifts to the right */
.main-content {
  margin-left: 240px;
  padding: 2rem 3rem;
  box-sizing: border-box;
  width: calc(100% - 240px);
}
#lowRatedTable th {
  cursor: pointer;
}


  </style>
</head>
<body>

  <div class="sidebar">
    <h2></h2>
    <nav class="side-nav">
      <a href="#about" class="active">01 About</a>
      <a href="#proposed-dashboard">02 Proposed dashboard</a>
<a href="#school-risk">03 Schools at high road safety risk</a>

    </nav>
  </div>
  
  <div class="main-content">
  
  <h1>Making roads safer for children in the Philippines:<br/>A project dashboard proposal</h1>
  <p style="color: #d32f2f; font-weight: bold;">
    <br/>WHY
  </p>
  
  <div style="width: 80%; margin-left: 0;">
    <p>
      This is to propose a project dashboard for the Child Road Traffic Injury Prevention program, a road safety improvement program in the Philippines which targets high-risk schools in the country. Its main purposes are:
    </p>
    <ul>
      <li>to track project progress, results, and priorities, and</li>
      <li>to facilitate communication within the team and stakeholders.</li>
    </ul>
    <img src="project3.png" alt="UNICEF project" style="margin-top: 1rem; max-width: 80%; border-radius: 8px;">

    <p style="color: #d32f2f; font-weight: bold;">
      <br/>WHAT
    </p>
    <p>
      The dashboard needs to show the number of school zones assessed per pilot city over the years, the resulting road safety ratings, and the schools at risk that need to be prioritized. A map of the schools was also requested.
    </p>
    <p style="color: #d32f2f; font-weight: bold;">
      <br/>HOW
    </p>
    <p>
      The initial dashboard plan is as follows:
      <br/>
      <img src="project2.png" alt="Initial dashboard plan" style="margin-top: 1rem; max-width: 80%; border-radius: 8px;">
      <br/><br/>Created Feb 2024
    </p>
  </div>
  
    
  <h1 id="proposed-dashboard"><br/><br/><br/>Proposed dashboard</h1>

  <!--
    <div style="display: flex; gap: 2rem; margin-bottom: 1.5rem;">
  <div style="flex: 1; background-color: #fef4f4; border-left: 5px solid #d32f2f; padding: 1rem; border-radius: 8px; text-align: center;">
    <div id="schoolsAssessed" style="font-size: 2.5rem; font-weight: bold; color: #d32f2f;">0</div>
    <div style="font-size: 1rem; font-weight: 500;">schools assessed</div>
  </div>
  <div style="flex: 1; background-color: #f4fef7; border-left: 5px solid #388e3c; padding: 1rem; border-radius: 8px; text-align: center;">
    <div id="schoolsRatedHigh" style="font-size: 2.5rem; font-weight: bold; color: #388e3c;">0</div>
    <div style="font-size: 1rem; font-weight: 500;">schools with star ratings of 3★ and up</div>
  </div>
</div>-->
 
  <div class="city-buttons">
    <p>Select a pilot city:</p>
    <button id="resetView">All</button>
    <button data-city="Zamboanga City">Zamboanga</button>
    <button data-city="Cagayan de Oro">Cagayan de Oro</button>
    <button data-city="Valenzuela City">Valenzuela</button>
    <button data-city="Angeles City">Angeles City</button>
  </div>

  <div class="map-chart-container">
    <div id="map">
      <div id="controls">
<div id="chart-container" style="flex: 1; display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-start; height: 400px;">
          <label for="yearSlider">Year: <span id="yearLabel">2025</span></label>
          <input type="range" id="yearSlider" min="2019" max="2025" value="2025" step="1">
          <button id="playButton">▶</button>
          <button id="restartButton">⟲</button>
        </div>
      </div>
      <p> sample hello!!!</p>
    </div>
    <div id="chart-container" style="width: 35%; display: flex; flex-direction: column; align-items: flex-start; height: 400px;">
      <h3 id="chart-title" style="margin-bottom: 0.5rem;">All Cities</h3>
      <div id="city-description" style="font-size: 0.95rem; color: #333; margin-bottom: 1rem;"></div>
      <canvas id="ratingChart" width="300" height="180"></canvas>
      <div id="chart-summary" style="margin-top: 1rem; font-size: 0.95rem; color: #333; display: flex; justify-content: center;">
        <a href="#dashboard" style="text-decoration: none; color: inherit; cursor: pointer;">
          <div id="highRiskSummary" style="font-size: 1rem;"></div>
        </a>
      </div>
      
    </div>
  </div>
  
  <div style="width: 65%; font-size: 0.95rem; line-height: 1.5;">
    <p>
      The school zones are assessed using Star Rating for Schools (starratingforschools.org/) and follows the star ratings of the International Road Assessment Programme (iRAP) (irap.org/). One of the UN Sustainable Development Goals is for roads to be built to a 3-star or better standard for all road users.
    <br/><br/>Note: Data used in this visualization is manipulated.
    </p>
  </div>
  
  <p><br/><br/></p>
  
  
  <h1 id="school-risk"><br/><br/><br/>Schools with high road safety risk</h1>
  
  <div style="display: flex; justify-content: flex-end; margin-top: 2rem;">
    <button onclick="downloadLowRatedCSV()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background-color: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer;">
      Download CSV
    </button>
  </div>
  


<!-- Table -->
<table id="lowRatedTable" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
  <thead>
    <tr style="background-color: #000; color: white;">
      <th style="padding: 0.5rem; border: 0px solid #ccc;">City</th>
      <th style="padding: 0.5rem; border: 0px solid #ccc;">School Name</th>
      <th style="padding: 0.5rem; border: 0px solid #ccc;">Star Rating</th>
      <th style="padding: 0.5rem; border: 0px solid #ccc;">Contact</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>



  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    function animateCount(el, value, suffix = '', duration = 800) {
      let start = 0;
      const step = Math.ceil(value / (duration / 30));
      const update = () => {
        start += step;
        if (start >= value) {
          start = value;
          clearInterval(timer);
        }
        let stars = '';
        if (suffix.includes('intervention') || suffix.includes('at high road safety risk')) {
  stars = '★<span style="color:#ea3323">★</span>';
} else if (suffix.includes('improve')) {
  stars = '<span style="color:#f5c342">★</span><span style="color:#ffff54">★</span>';
} else if (suffix.includes('maintain')) {
  stars = '<span style="color:#9fce63">★</span>';
}
el.innerHTML = `
  <div style="text-align: center;">
    <span style="font-size: 1.2rem; font-weight: bold;">
      <span style="font-size: 1rem; font-weight: bold;">${stars}</span> ${start}
    </span>
    <span style="font-size: 1.2rem; font-weight: bold;"> ${suffix}</span>
  </div>`;
  };
  const timer = setInterval(update, 30);
}

    const map = L.map('map').setView([13.0, 121.0], 5.4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);


    let schoolLayer;
    let allFeatures = [];
    let selectedCity = null;

    const ratingChart = new Chart(document.getElementById("ratingChart"), {
      type: 'bar',
      data: {
        labels: ["Star 1", "Star 2", "Star 3", "Star 4", "Star 5", "Unrated"],
        datasets: [{
          label: "Schools by Rating",
          data: [0, 0, 0, 0, 0, 0],
          backgroundColor: ["#000000", "#ea3323", "#f5c342", "#ffff54", "#9fce63", "#ffffff"],
          borderColor: "#fff"
        }]
      },
      options: {
  indexAxis: 'y',
  responsive: true,
  maintainAspectRatio: false,
  scales: {
    x: {
      stacked: true,
      beginAtZero: true,
      max: 60,
      title: {
        display: true,
        text: 'No. of schools',
        font: { size: 12 }
      }
    },
    y: {
      stacked: true,
      title: {
        display: true,
        text: 'Star rating',
        font: { size: 12 }
      }
    }
  },
  plugins: {
    legend: { display: false }
  }
}

    });

    function updateChart(data) {
      ratingChart.data.datasets[0].data = data;
      ratingChart.update();
      const nHighRisk = data[0] + data[1]; // Star 1 + Star 2
const summary = document.getElementById("highRiskSummary");
animateCount(summary, nHighRisk, "school(s) at high road safety risk!", 800);

    }

    function createColoredSVGIcon(color) {
      const shadow = color === "#ffffff" ? "filter: drop-shadow(0 0 0.5px #000);" : "";
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 24 24' fill='${color}' style='${shadow}'><path d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/></svg>`;
      return L.divIcon({
        className: '',
        html: svg,
        iconSize: [30, 30],
        iconAnchor: [15, 15],
        popupAnchor: [0, -10]
      });
    }

    function ratingColor(rating) {
      return {
        1: "#000000",
        2: "#ea3323",
        3: "#f5c342",
        4: "#ffff54",
        5: "#9fce63"
      }[rating] || "#ffffff";
    }

    fetch("sr4s_mod.geojson")
      .then(res => res.json())
      .then(data => {
        allFeatures = data.features;
        updateMap(2025);
      });

    function updateMap(year) {
  function animateValue(id, value, duration = 800) {
    const el = document.getElementById(id);
    let start = 0;
    const step = Math.ceil(value / (duration / 30));
    const timer = setInterval(() => {
      start += step;
      if (start >= value) {
        start = value;
        clearInterval(timer);
      }
      el.textContent = start;
    }, 30);
  }
      let cityFilter = selectedCity;
      if (schoolLayer) map.removeLayer(schoolLayer);
      let filtered = allFeatures.filter(f => f.properties.year <= year);
      if (cityFilter) {
        filtered = filtered.filter(f => f.properties.city && f.properties.city.toLowerCase() === cityFilter.toLowerCase());
      }
      const ratingCount = [0, 0, 0, 0, 0, 0];
      filtered.forEach(f => {
        const r = parseInt(f.properties.star_rating);
        if (r >= 1 && r <= 5) ratingCount[r - 1]++;
        else ratingCount[5]++;
      });
      updateChart(ratingCount);
      updateLowRatedTable(filtered);


  const total = filtered.length;
  const rated3up = filtered.filter(f => {
    const r = parseInt(f.properties.star_rating);
    return r >= 3 && r <= 5;
  }).length;
  animateValue("schoolsAssessed", total);
  animateValue("schoolsRatedHigh", rated3up);
      document.getElementById("chart-title").textContent = selectedCity || 'All Cities';
      const cityDescriptions = {
        "Zamboanga City": "Zamboanga has a diverse mix of road conditions around its schools and ongoing improvement initiatives.<br><br>Partner institution: City Government of Zamboanga<br>No. of school zones assessed: 101",
        "Cagayan de Oro": "Cagayan de Oro schools are undergoing road safety audits and community engagement efforts.<br><br>Partner institution: City of Cagayan de Oro<br>No. of school zones assessed: 25",
        "Valenzuela City": "Valenzuela continues to expand pedestrian infrastructure near schools.<br><br>Partner institution: City Government of Valenzuela<br>No. of school zones assessed: 72",
        "Angeles City": "Angeles City features a number of schools in dense urban areas, with varying safety levels.<br><br>Partner institution: Angeles City Traffic Development Office<br>No. of school zones assessed: 25"
      };
      const desc = selectedCity && cityDescriptions[selectedCity] ? cityDescriptions[selectedCity] : "";
      document.getElementById("city-description").innerHTML = desc;
      schoolLayer = L.geoJSON(filtered, {
        pointToLayer: function (feature, latlng) {
          const rating = parseInt(feature.properties.star_rating);
          const color = ratingColor(rating);
          return L.marker(latlng, { icon: createColoredSVGIcon(color), opacity: 1.0 });
        },
        onEachFeature: function (feature, layer) {
          const props = feature.properties;
          const popupContent = `
            <strong>${props.name}</strong><br/>
            Star Rating: ${props.star_rating || 'Unrated'}<br/>
            Year: ${props.year}<br/>
            Intervention: ${props.intervention === 'Y' ? 'Yes' : 'No'}
          `;
          layer.bindPopup(popupContent);
        }
      }).addTo(map);
    }

    document.getElementById('yearSlider').addEventListener('input', function () {
      const selectedYear = parseInt(this.value);
      document.getElementById('yearLabel').innerText = selectedYear;
      updateMap(selectedYear);
    });

    const cityCoords = {
      "Zamboanga City": [7.0670, 122.0790],
      "Cagayan de Oro": [8.4415, 124.6319],
      "Valenzuela City": [14.7100, 120.9830],
      "Angeles City": [15.1573, 120.5849]
    };

    document.querySelectorAll('.city-buttons button').forEach(button => {
      button.addEventListener('click', () => {
        const city = button.dataset.city;
        if (cityCoords[city]) {
          const zoomLevels = {
            "Zamboanga City": 10.7,
            "Cagayan de Oro": 11.4,
            "Valenzuela City": 12.8,
            "Angeles City": 12.8
          };
          const zoom = zoomLevels[city] || 12;
          map.flyTo(cityCoords[city], zoom);
          selectedCity = city;
          const selectedYear = parseInt(document.getElementById('yearSlider').value);
          updateMap(selectedYear);
        }
      });
    });

    document.getElementById('resetView').addEventListener('click', () => {
      selectedCity = null;
      const year = parseInt(document.getElementById('yearSlider').value);
      map.flyTo([13.0, 121.0], 5.5);
      updateMap(year);
    });

    let yearInterval = null;
    let playing = false;
    document.getElementById("playButton").addEventListener("click", () => {
      if (!playing) {
        playing = true;
        document.getElementById("playButton").textContent = "⏸";
        yearInterval = setInterval(() => {
          let slider = document.getElementById("yearSlider");
          let current = parseInt(slider.value);
          if (current < 2025) {
            slider.value = current + 1;
            slider.dispatchEvent(new Event("input"));
          } else {
            clearInterval(yearInterval);
            document.getElementById("playButton").textContent = "▶";
            playing = false;
          }
        }, 1000);
      } else {
        clearInterval(yearInterval);
        document.getElementById("playButton").textContent = "▶";
        playing = false;
      }
    });

    document.getElementById("restartButton").addEventListener("click", () => {
      const slider = document.getElementById("yearSlider");
      slider.value = 2019;
      slider.dispatchEvent(new Event("input"));
    });
    function updateLowRatedTable(data) {
  const tableBody = document.getElementById("lowRatedTable").querySelector("tbody");
  tableBody.innerHTML = "";

  data
    .filter(f => parseInt(f.properties.star_rating) >= 1 && parseInt(f.properties.star_rating) <= 2)
    .forEach(f => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td style='padding: 0.5rem; border: 1px solid #ccc;'>${f.properties.city}</td>
        <td style='padding: 0.5rem; border: 1px solid #ccc;'>${f.properties.name}</td>
        <td style='padding: 0.5rem; border: 1px solid #ccc;'>${f.properties.star_rating}</td>
        <td style='padding: 0.5rem; border: 1px solid #ccc;'></td>
      `;
      tableBody.appendChild(row);
    });
}

function downloadLowRatedCSV() {
  const rows = Array.from(document.querySelectorAll('#lowRatedTable tr'));
  const csv = rows.map(row =>
    Array.from(row.querySelectorAll('th, td'))
      .map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`)
      .join(',')
  ).join('\\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.setAttribute('href', url);
  link.setAttribute('download', 'low_rated_schools.csv');
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

document.addEventListener('DOMContentLoaded', () => {
  const getCellValue = (tr, idx) => tr.children[idx].innerText;
  const comparer = (idx, asc) => (a, b) =>
    ((v1, v2) => 
      v1.localeCompare(v2, undefined, { numeric: true })
    )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

  document.querySelectorAll('#lowRatedTable th').forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', (() => {
      const table = th.closest('table');
      Array.from(table.querySelectorAll('tbody tr'))
        .sort(comparer(Array.from(th.parentNode.children).indexOf(th), this.asc = !this.asc))
        .forEach(tr => table.querySelector('tbody').appendChild(tr));
    }));
  });
});


  </script>

</div> <!-- closes main-content -->

</body>
</html>
